<section class="consult-shell" [class.completed]="status === 'completed'">
  <!-- Header Bar -->
  <header class="shell-header">
    <div class="shell-header__left">
      <button class="shell-back-btn" type="button" (click)="goBack()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
      </button>
      <div class="shell-info">
        <h2 class="shell-title">Consultation</h2>
        <span class="shell-party">with {{ otherPartyName }}</span>
      </div>
    </div>
    <div class="shell-header__right">
      <span class="shell-timer">{{ elapsedTime }}</span>
      <span class="shell-mode-badge" [class]="'mode-' + mode">
        @if (mode === 'video') {
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="23 7 16 12 23 17 23 7"/>
            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
          </svg>
        } @else if (mode === 'audio') {
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/>
          </svg>
        } @else {
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
        }
        {{ modeLabel }}
      </span>
      <span class="shell-status-badge" [class]="'status-' + status">
        @if (status === 'connecting') {
          Connecting...
        } @else if (status === 'active') {
          Active
        } @else if (status === 'completed') {
          Completed
        } @else {
          Error
        }
      </span>
    </div>
  </header>

  @if (errorMessage) {
    <div class="shell-error" role="alert">
      <span>{{ errorMessage }}</span>
      <button type="button" (click)="errorMessage = ''">Dismiss</button>
    </div>
  }

  <!-- Main Content Area -->
  <div class="shell-body">
    <!-- Status / Completed Banner -->
    @if (status === 'completed') {
      <div class="shell-completed-banner">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <div>
          <h3>Consultation Completed</h3>
          <p>Duration: {{ elapsedTime }}</p>
        </div>
        <button class="btn btn-primary" type="button" (click)="goBack()">Return to Dashboard</button>
      </div>
    }

    @if (status === 'active') {
      <!-- Call Action Panel (video/audio modes) -->
      @if (mode === 'video' || mode === 'audio') {
        <div class="shell-call-panel">
          @if (!callActive) {
            <div class="call-prompt">
              @if (mode === 'video') {
                <svg class="call-prompt-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="23 7 16 12 23 17 23 7"/>
                  <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                </svg>
                <h3>Ready for Video Call</h3>
                <p>Click below to open the video consultation in a new tab.</p>
              } @else {
                <svg class="call-prompt-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/>
                </svg>
                <h3>Ready for Audio Call</h3>
                <p>Click below to start an audio consultation in a new tab.</p>
              }
              <button class="btn btn-primary btn-lg" type="button" (click)="startCall()" [disabled]="!roomUrl">
                @if (mode === 'video') {
                  Start Video Call
                } @else {
                  Start Audio Call
                }
              </button>
            </div>
          } @else {
            <div class="call-active-indicator">
              <div class="call-pulse"></div>
              <span>{{ mode === 'video' ? 'Video' : 'Audio' }} call in progress (new tab)</span>
              <button class="btn btn-secondary btn-sm" type="button" (click)="startCall()">Rejoin Call</button>
            </div>
          }
        </div>
      }

      <!-- Chat Escalation (chat mode only) -->
      @if (mode === 'chat' && canEscalateToCall) {
        <div class="shell-escalate-bar">
          <span>Need to talk?</span>
          <button class="btn btn-secondary btn-sm" type="button" (click)="escalateToCall()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="23 7 16 12 23 17 23 7"/>
              <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
            </svg>
            Start Video Call
          </button>
        </div>
      }

      @if (callActive && mode === 'chat') {
        <div class="call-active-indicator compact">
          <div class="call-pulse"></div>
          <span>Video call in progress (new tab)</span>
          <button class="btn btn-secondary btn-sm" type="button" (click)="escalateToCall()">Rejoin</button>
        </div>
      }

      <!-- Chat Panel (always shown when active) -->
      <div class="shell-chat-area">
        @if (consultationId) {
          <app-chat-panel
            [consultationId]="consultationId"
            [currentUserId]="currentUserId"
            [disabled]="status !== 'active'"
          ></app-chat-panel>
        }
      </div>

      <!-- GP Actions Footer -->
      @if (isGp) {
        <footer class="shell-footer">
          <div class="shell-footer__actions">
            <button class="btn btn-danger-outline" type="button" (click)="openEndConfirm()" [disabled]="ending">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
              </svg>
              End Consultation
            </button>
          </div>
        </footer>
      }
    }
  </div>
</section>

<!-- End Consultation Confirmation Modal (FLOW-05) -->
@if (showEndConfirm) {
  <div class="modal-overlay" (click)="cancelEnd()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">End Consultation</h2>
        <button class="modal-close" type="button" (click)="cancelEnd()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p class="end-confirm-text">
          Are you sure you want to end the consultation with {{ otherPartyName }}?
          The patient will be notified and the session will be marked as completed.
        </p>
        <div class="form-group">
          <label class="form-label">Consultation Notes (optional)</label>
          <textarea
            class="form-input form-textarea"
            rows="4"
            placeholder="Add notes about this consultation..."
            [(ngModel)]="endNotes"
          ></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" type="button" (click)="cancelEnd()">Cancel</button>
        <button class="btn btn-danger" type="button" (click)="confirmEnd()" [disabled]="ending">
          {{ ending ? 'Ending...' : 'End Consultation' }}
        </button>
      </div>
    </div>
  </div>
}
