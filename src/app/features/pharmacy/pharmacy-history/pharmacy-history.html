<section class="pharmacy-history">
  <div class="history-container">
    <!-- Page Header -->
    <header class="page-header">
      <h1 class="page-title">Prescription History</h1>
      <p class="page-subtitle">Review previously dispensed prescriptions</p>
    </header>

    <div class="loading-banner" *ngIf="loading" role="status">
      Loading prescription history...
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-grid">
        <div class="filter-group">
          <input type="text" class="filter-input" placeholder="Patient name" [(ngModel)]="filters.patientName"
            (ngModelChange)="onFilterChange()" />
        </div>
        <div class="filter-group">
          <input type="text" class="filter-input" placeholder="Prescription ID" [(ngModel)]="filters.prescriptionId"
            (ngModelChange)="onFilterChange()" />
        </div>
        <div class="filter-group">
          <select class="filter-select" [(ngModel)]="filters.status" (ngModelChange)="onFilterChange()">
            <option value="">All Statuses</option>
            <option value="completed">Completed</option>
            <option value="pending">Pending</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div class="filter-group">
          <select class="filter-select" [(ngModel)]="filters.dateRange" (ngModelChange)="onFilterChange()">
            <option value="">All Dates</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
          </select>
        </div>
      </div>
      <div class="filter-actions"
        *ngIf="filters.patientName || filters.prescriptionId || filters.status || filters.dateRange">
        <button type="button" class="clear-filters-btn" (click)="clearFilters()">
          Clear Filters
        </button>
        <span class="results-count">{{ filteredItems.length }} result{{ filteredItems.length !== 1 ? 's' : '' }}</span>
      </div>
    </div>

    <!-- History List -->
    <div class="history-list-container" *ngIf="hasResults()">
      <div class="history-group" *ngFor="let groupKey of groupedItemsKeys">
        <h2 class="date-header">{{ groupKey }}</h2>
        <div class="history-list">
          <div class="history-item" *ngFor="let item of getItemsForGroup(groupKey)">
            <div class="history-item__icon-wrapper"
              [class.history-item__icon-wrapper--cancelled]="item.status === 'cancelled'"
              [class.history-item__icon-wrapper--pending]="item.status === 'pending'">
              <svg class="history-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <ng-container *ngIf="item.status === 'completed'">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </ng-container>
                <ng-container *ngIf="item.status === 'pending'">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </ng-container>
                <ng-container *ngIf="item.status === 'cancelled'">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                </ng-container>
              </svg>
            </div>
            <div class="history-item__info">
              <span class="history-item__title">{{ item.code }}</span>
              <span class="history-item__subtitle">{{ item.patientName }} â€¢ {{ item.itemCount }} item{{ item.itemCount
                !== 1 ? 's' : '' }}</span>
            </div>
            <div class="history-item__meta">
              <span class="history-item__time">{{ item.time }}</span>
              <span class="hhi-badge" [class.hhi-badge--success]="item.status === 'completed'"
                [class.hhi-badge--warning]="item.status === 'pending'"
                [class.hhi-badge--error]="item.status === 'cancelled'">
                {{ item.status | titlecase }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="hhi-empty-state" *ngIf="!hasResults()">
      <div class="hhi-empty-state__icon-wrapper">
        <svg class="hhi-empty-state__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
          stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      </div>
      <p class="hhi-empty-state__title">No prescriptions found</p>
      <p class="hhi-empty-state__description">Try adjusting your filters or date range.</p>
      <button class="hhi-button-ghost" (click)="clearFilters()">Clear Filters</button>
    </div>
  </div>

  <!-- Mobile Bottom Navigation -->
  <app-bottom-nav [tabs]="PHARMACY_TABS" activeTab="history"></app-bottom-nav>
</section>