<section class="order-details">
  <div class="details-container">
    <!-- Back Button -->
    <div class="details-header">
      <button class="btn btn-ghost back-button" (click)="goBack()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5M12 19l-7-7 7-7"></path>
        </svg>
        Back to Orders
      </button>
    </div>

    <div class="status-banner status-banner--error" *ngIf="errorMessage">{{ errorMessage }}</div>

    <!-- Order Title Section -->
    <div class="order-title-section">
      <div class="order-title-row">
        <h1 class="order-id">DX-{{ order?.id | slice:0:8 }}</h1>
      </div>
      <p class="order-received">Received {{ order?.created_at | date:'short' }}</p>
    </div>

    <!-- Status Pipeline -->
    <div class="status-pipeline">
      <div class="status-pipeline__step status-pipeline__step--complete">
        <div class="status-pipeline__step-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        <span class="status-pipeline__step-label">Received</span>
      </div>
      <div class="status-pipeline__connector status-pipeline__connector--complete"></div>
      <div class="status-pipeline__step"
        [ngClass]="{'status-pipeline__step--complete': order?.status === 'in_progress' || order?.status === 'completed', 'status-pipeline__step--active': order?.status === 'ordered'}">
        <div class="status-pipeline__step-icon"
          *ngIf="order?.status === 'in_progress' || order?.status === 'completed'">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        <div class="status-pipeline__step-icon"
          *ngIf="order?.status !== 'in_progress' && order?.status !== 'completed'">2</div>
        <span class="status-pipeline__step-label">Collected</span>
      </div>
      <div class="status-pipeline__connector"
        [ngClass]="{'status-pipeline__connector--complete': order?.status === 'in_progress' || order?.status === 'completed'}">
      </div>
      <div class="status-pipeline__step"
        [ngClass]="{'status-pipeline__step--complete': order?.status === 'completed', 'status-pipeline__step--active': order?.status === 'in_progress'}">
        <div class="status-pipeline__step-icon" *ngIf="order?.status === 'completed'">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        <div class="status-pipeline__step-icon" *ngIf="order?.status !== 'completed'">3</div>
        <span class="status-pipeline__step-label">In Lab</span>
      </div>
      <div class="status-pipeline__connector"
        [ngClass]="{'status-pipeline__connector--complete': order?.status === 'completed'}"></div>
      <div class="status-pipeline__step" [ngClass]="{'status-pipeline__step--complete': order?.status === 'completed'}">
        <div class="status-pipeline__step-icon" *ngIf="order?.status === 'completed'">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        <div class="status-pipeline__step-icon" *ngIf="order?.status !== 'completed'">4</div>
        <span class="status-pipeline__step-label">Ready</span>
      </div>
    </div>

    <!-- Patient Info Card -->
    <div class="card patient-card">
      <div class="patient-header">
        <div class="avatar">{{ getPatientInitials() }}</div>
        <div class="patient-details">
          <h2 class="patient-name">{{ order?.patient_name || 'Patient' }}</h2>
          <p class="patient-meta patient-masked-info">
            <span class="patient-masked-info__lock">ðŸ”’</span> +254 â€¢â€¢â€¢ â€¢â€¢â€¢ {{ getMaskedPhone() }}
          </p>
        </div>
      </div>
    </div>

    <!-- Clinical Indication -->
    <div class="section">
      <h2 class="section-title">Clinical Indication</h2>
      <div class="info-box info-box-clinical">
        <p>
          Patient presents with fatigue, unexplained weight loss, and increased thirst.
          PCP suspects possible diabetes or thyroid dysfunction. Comprehensive metabolic
          panel ordered to evaluate glucose levels and thyroid function.
        </p>
      </div>
    </div>

    <!-- Sample Requirements -->
    <div class="section">
      <h2 class="section-title">Sample Requirements</h2>
      <div class="sample-types">
        <div class="sample-item">
          <svg class="sample-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M20.2 17.6l-2.8-2.8a4 4 0 0 0-5.6 0l-.4.4a4 4 0 0 1-5.6 0l-2.8-2.8a4 4 0 0 1 0-5.6l.4-.4a4 4 0 0 0 0-5.6L5.6 0H24v18.4l-3.8-3.8a4 4 0 0 0 0 5.6l-.4.4z">
            </path>
          </svg>
          <span>Blood (Fasting required - 8 hours)</span>
        </div>
        <div class="sample-item">
          <svg class="sample-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M20.2 17.6l-2.8-2.8a4 4 0 0 0-5.6 0l-.4.4a4 4 0 0 1-5.6 0l-2.8-2.8a4 4 0 0 1 0-5.6l.4-.4a4 4 0 0 0 0-5.6L5.6 0H24v18.4l-3.8-3.8a4 4 0 0 0 0 5.6l-.4.4z">
            </path>
          </svg>
          <span>Urine (Mid-stream clean catch)</span>
        </div>
      </div>
    </div>

    <!-- Test Checklist -->
    <div class="section">
      <h2 class="section-title">Tests Ordered</h2>

      <div class="checklist">
        <div class="checklist-item" *ngFor="let test of order?.tests; let i = index">
          <label class="checkbox-label">
            <input type="checkbox" class="checkbox-input" />
            <span class="checkbox-mark"></span>
            <div class="test-info">
              <span class="test-name">{{ test }}</span>
              <div class="result-range-bar-wrapper" *ngIf="order?.status === 'completed'">
                <div class="result-range-bar">
                  <div class="result-range-bar__track">
                    <div class="result-range-bar__normal-zone" style="left: 20%; width: 50%"></div>
                    <div class="result-range-bar__value-dot" [class.result-range-bar__value-dot--out-of-range]="i === 1"
                      [style.left.%]="30 + i * 50"></div>
                  </div>
                </div>
                <div class="result-range-bar__labels">
                  <span>Result: {{ 4.2 + i * 4 | number:'1.1-1' }} <strong class="text-danger"
                      *ngIf="i === 1">HIGH</strong></span>
                  <span>Normal: 3.5 - 5.5</span>
                </div>
              </div>
            </div>
          </label>
        </div>
      </div>
    </div>

    <!-- Special Instructions -->
    <div class="section">
      <h2 class="section-title">Special Instructions</h2>
      <div class="card instructions-card">
        <ul class="instructions-list">
          <li>Patient must be fasting for at least 8 hours prior to blood draw</li>
          <li>Collect blood samples before 10 AM for accurate cortisol levels</li>
          <li>Verify patient identity with two identifiers before collection</li>
          <li>Label all specimens immediately after collection</li>
        </ul>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="actions-section">
      <div class="status-banner" *ngIf="printStatusMessage" role="status" aria-live="polite">
        {{ printStatusMessage }}
      </div>
      <button type="button" class="btn btn-primary btn-full" data-testid="diagnostics-accept-order"
        (click)="acceptOrder()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Accept & Start Processing
      </button>
      <div class="secondary-actions">
        <button type="button" class="btn btn-secondary" (click)="printLabel()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 6 2 18 2 18 9"></polyline>
            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
            <rect x="6" y="14" width="12" height="8"></rect>
          </svg>
          Print Label
        </button>
        <button type="button" class="btn btn-danger" data-testid="diagnostics-reject-order"
          [disabled]="!rejectOrderAvailable" [attr.aria-disabled]="!rejectOrderAvailable" title="Coming soon">
          Reject Order <span class="coming-soon-label">Coming soon</span>
        </button>
      </div>
    </div>
  </div>

  <app-bottom-nav [tabs]="DIAGNOSTICS_TABS" activeTab="orders"></app-bottom-nav>
</section>
