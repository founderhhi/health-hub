<section class="diagnostics-orders">
  <div class="orders-container">
    <!-- Page Header -->
    <header class="page-header">
      <div>
        <h1 class="page-title">Diagnostics Orders</h1>
        <p class="page-subtitle">Manage incoming diagnostic orders</p>
      </div>
      <button type="button" class="profile-button" (click)="openProfile()" aria-label="Open diagnostics profile">
        <app-profile-button label="Open diagnostics profile" [initials]="profileInitials"></app-profile-button>
      </button>
    </header>

    <!-- Collapsible Filter Section -->
    <div class="filters-section">
      <button class="filter-toggle" (click)="toggleFilters()" [attr.aria-expanded]="filtersExpanded">
        <svg class="filter-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
        </svg>
        <span>Filters</span>
        <svg class="toggle-icon" [class.expanded]="filtersExpanded" width="16" height="16" viewBox="0 0 24 24"
          fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </button>

      <div class="filters-content" [class.expanded]="filtersExpanded">
        <div class="filters-inner">
          <p class="filters-helper">
            Limited filters in place. Full functionality coming soon.
          </p>
          <div class="filters-grid">
            <input type="text" class="filter-input" placeholder="Order ID" [(ngModel)]="orderIdSearch" />
            <input type="text" class="filter-input" placeholder="Patient name" [disabled]="true" />
            <select class="filter-select" [(ngModel)]="statusFilter">
              <option value="All Status">All Status</option>
              <option value="Pending">Pending</option>
              <option value="In Progress">In Progress</option>
              <option value="Completed">Completed</option>
            </select>
            <div class="priority-filter-wrapper">
              <select class="filter-select" [disabled]="true">
                <option value="">All Priorities</option>
                <option value="normal">Normal</option>
                <option value="urgent">Urgent</option>
              </select>
              <span class="coming-soon-pill">Coming Soon</span>
            </div>
            <select class="filter-select filter-select--mobile-only" [disabled]="true">
              <option value="">All Priorities</option>
              <option value="normal">Normal</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Orders List -->
    <div class="orders-list" *ngIf="filteredOrders.length > 0">
      <div class="order-card" *ngFor="let order of filteredOrders" [ngClass]="{
             'order-card--pending': order.status === 'Pending',
             'order-card--progress': order.status === 'In Progress',
             'order-card--ready': order.status === 'Completed',
             'order-card--urgent': order.priority === 'Urgent'
           }">
        <span class="demo-badge" *ngIf="order.isDemo">Demo Data</span>
        <div class="order-card-header">
          <span class="order-id">{{ order.orderId }}</span>
          <div class="order-badges">
            <span class="hhi-badge hhi-badge--urgent" *ngIf="order.priority === 'Urgent'">Urgent</span>
            <span class="hhi-badge hhi-badge--ready"
              *ngIf="order.status === 'Pending' && order.priority !== 'Urgent'">New</span>
            <span class="hhi-badge" [ngClass]="getStatusClass(order)">
              {{ order.status }}
            </span>
          </div>
        </div>
        <div class="order-patient">
          <div class="order-card__avatar">{{ getInitials(order.patientName) }}</div>
          <div class="patient-details">
            <span class="patient-name">{{ order.patientName }}</span>
            <span class="patient-masked-info">
              <span class="patient-masked-info__lock">ðŸ”’</span>
              +254 â€¢â€¢â€¢ â€¢â€¢â€¢ {{ order.patientPhone | slice:-4 }}
            </span>
          </div>
        </div>
        <div class="order-tests">
          <span class="test-item" *ngFor="let test of order.tests">{{ test }}</span>
        </div>
        <progress class="order-progress" value="50" max="100" aria-label="Order 50% complete"
          *ngIf="order.status === 'In Progress'"></progress>
        <div class="order-footer">
          <div class="order-card__time">
            <span class="order-date" [title]="order.orderedDate">{{ order.orderedRelative || order.orderedDate }}</span>
          </div>
          <button class="btn btn-primary" [disabled]="!order.id" (click)="viewLiveOrder(order)">View Order</button>
        </div>
      </div>
    </div>

    <!-- [AGENT_DIAGNOSTICS] ISS-19: show error message when API call fails -->
    <div class="empty-state empty-state--error" *ngIf="errorMessage">
      <p class="error-message">{{ errorMessage }}</p>
    </div>

    <div class="empty-state" *ngIf="orders.length === 0 && !hasActiveFilters && !errorMessage">
      <p>No diagnostic orders yet.</p>
    </div>

    <div class="empty-state" *ngIf="orders.length > 0 && filteredOrders.length === 0">
      <svg class="empty-state-icon" width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="7"></circle>
        <path d="m21 21-4.3-4.3"></path>
        <path d="m8.5 8.5 5 5"></path>
        <path d="m13.5 8.5-5 5"></path>
      </svg>
      <p>No orders found matching your filters</p>
      <span>Try adjusting your search or filter criteria</span>
      <button type="button" class="btn btn-secondary" (click)="clearFilters()">Clear Filters</button>
    </div>

    <!-- Pull to refresh indicator -->
    <div class="pull-refresh">
      <ng-template #pullToRefreshContent>
        <div class="pull-refresh">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
          <span>Pull to refresh orders</span>
        </div>
      </ng-template>
    </div>
  </div>

  <app-bottom-nav [tabs]="DIAGNOSTICS_TABS" activeTab="orders"></app-bottom-nav>
</section>
