<section class="gp-dashboard">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-left">
      <h1 class="page-title">GP Dashboard</h1>
      <p class="header-date">{{ today | date:'EEEE, MMMM d, yyyy' }}</p>
    </div>
    <div class="header-actions">
      <button class="refresh-btn" (click)="refreshQueue()" [class.refreshing]="isRefreshing">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"/>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
        <span class="refresh-text">Auto-refresh in {{ refreshCountdown }}s</span>
      </button>
      <button class="icon-btn" (click)="viewProfile()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
      </button>
    </div>
  </header>

  @if (unavailableNotice) {
    <div class="unavailable-notice" role="status" aria-live="polite">
      <span>{{ unavailableNotice }}</span>
      <button class="notice-dismiss" type="button" (click)="dismissUnavailableNotice()" aria-label="Dismiss notice">
        Dismiss
      </button>
    </div>
  }

  <div class="dashboard-content">
    <!-- Left Column: Queue (70%) -->
    <div class="queue-section">
      <!-- Stats Cards Row -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon waiting">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ stats.waiting }}</span>
            <span class="stat-label">Waiting</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="23 7 16 12 23 17 23 7"/>
              <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
            </svg>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ stats.active }}</span>
            <span class="stat-label">Active Sessions</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon completed">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ stats.completed }}</span>
            <span class="stat-label">Completed Today</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon time">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ stats.avgTime }}m</span>
            <span class="stat-label">Avg. Session</span>
          </div>
        </div>
      </div>

      <!-- Queue Header -->
      <div class="queue-header">
        <h2 class="section-title">Patient Queue</h2>
        <div class="queue-filters">
          <button class="filter-btn active">All</button>
          <button class="filter-btn">Urgent</button>
          <button class="filter-btn">Video</button>
          <button class="filter-btn">In-person</button>
        </div>
      </div>

      <!-- Queue List -->
      @if (queue.length > 0) {
        <div class="queue-list">
          @for (patient of queue; track patient.id; let i = $index) {
            <div
              class="queue-item"
              [class.priority-urgent]="patient.priority === 'urgent'"
              [class.priority-emergency]="patient.priority === 'emergency'"
            >
              <div class="queue-number">#{{ i + 1 }}</div>

              <div class="patient-info">
                <div class="patient-header">
                  <h3 class="patient-name">{{ patient.name }}</h3>
                  <span class="priority-badge" [class]="'priority-' + patient.priority">
                    {{ patient.priority | titlecase }}
                  </span>
                </div>

                <div class="patient-meta">
                  <span class="meta-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    Waiting: {{ patient.waitTime }}
                  </span>
                  <span class="meta-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      @if (patient.mode === 'video') {
                        <polygon points="23 7 16 12 23 17 23 7"/>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                      } @else {
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                      }
                    </svg>
                    {{ patient.mode | titlecase }}
                  </span>
                </div>

                <!-- AI Intake Summary -->
                @if (patient.aiSummary) {
                  <div class="ai-summary">
                    <div class="ai-badge">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                      </svg>
                      AI Summary
                    </div>
                    <p class="summary-text">{{ patient.aiSummary }}</p>
                  </div>
                }
              </div>

              <div class="queue-actions">
                <button class="btn btn-primary" (click)="acceptPatient(patient.id)" [disabled]="patient.accepted">
                  {{ patient.accepted ? 'Accepted' : 'Accept' }}
                </button>
                <button class="btn btn-secondary" (click)="prescribe(patient.patientId)">
                  Prescribe
                </button>
                <button class="btn btn-secondary" (click)="referToSpecialist(patient.patientId)">
                  Refer
                </button>
                <button class="btn btn-ghost" (click)="viewDetails(patient.id)">
                  Details
                </button>
              </div>
            </div>
          }
        </div>
      } @else {
        <!-- Empty State -->
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="12" r="10"/>
            <line x1="8" y1="12" x2="16" y2="12"/>
          </svg>
          <h3>No Patients Waiting</h3>
          <p>The queue is currently empty. Take a break or review past consultations.</p>
          <button class="btn btn-secondary" type="button" disabled aria-disabled="true">
            View History (Coming soon)
          </button>
        </div>
      }
    </div>

    <!-- Right Column: Quick Actions (30%) -->
    <aside class="sidebar">
      <div class="sidebar-card">
        <h3 class="sidebar-title">Quick Actions</h3>
        <div class="quick-actions">
          <button class="quick-action-btn" (click)="startBreak()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="6" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            Take Break
          </button>
          <button class="quick-action-btn" type="button" disabled aria-disabled="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            My Schedule (Coming soon)
          </button>
          <button class="quick-action-btn" type="button" disabled aria-disabled="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            My Patients (Coming soon)
          </button>
          <button class="quick-action-btn" type="button" disabled aria-disabled="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            Settings (Coming soon)
          </button>
        </div>
      </div>

      <div class="sidebar-card">
        <h3 class="sidebar-title">Today's Summary</h3>
        <div class="summary-list">
          <div class="summary-item">
            <span class="summary-label">First Patient</span>
            <span class="summary-value">9:00 AM</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Current Streak</span>
            <span class="summary-value">5 patients</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Break Time</span>
            <span class="summary-value">30 min</span>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Mobile Bottom Navigation -->
  <nav class="bottom-nav">
    <a class="nav-item active" routerLink="/gp">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="7" height="7"/>
        <rect x="14" y="3" width="7" height="7"/>
        <rect x="14" y="14" width="7" height="7"/>
        <rect x="3" y="14" width="7" height="7"/>
      </svg>
      <span class="nav-label">Dashboard</span>
    </a>
    <button class="nav-item nav-item-disabled" type="button" disabled aria-disabled="true">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
      </svg>
      <span class="nav-label">Patients</span>
      <span class="nav-sub-label">Coming soon</span>
    </button>
    <button class="nav-item nav-item-disabled" type="button" disabled aria-disabled="true">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      <span class="nav-label">Schedule</span>
      <span class="nav-sub-label">Coming soon</span>
    </button>
    <button class="nav-item nav-item-disabled" type="button" disabled aria-disabled="true">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
      <span class="nav-label">Profile</span>
      <span class="nav-sub-label">Coming soon</span>
    </button>
  </nav>
</section>

<!-- ═══════════════════════════════════════════
     Prescription Modal
     ═══════════════════════════════════════════ -->
@if (showPrescriptionModal) {
  <div class="modal-overlay" (click)="closePrescriptionModal()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">New Prescription</h2>
        <button class="modal-close" (click)="closePrescriptionModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        @for (item of prescriptionItems; track $index; let i = $index) {
          <div class="prescription-item-card">
            <div class="prescription-item-header">
              <span class="item-number">Medication #{{ i + 1 }}</span>
              @if (prescriptionItems.length > 1) {
                <button class="remove-item-btn" (click)="removePrescriptionItem(i)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6l-2 14a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2L5 6"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                  </svg>
                  Remove
                </button>
              }
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Medication Name</label>
                <input
                  type="text"
                  class="form-input"
                  placeholder="e.g. Amoxicillin"
                  [(ngModel)]="item.name"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Dosage</label>
                <input
                  type="text"
                  class="form-input"
                  placeholder="e.g. 500mg"
                  [(ngModel)]="item.dosage"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Frequency</label>
                <input
                  type="text"
                  class="form-input"
                  placeholder="e.g. 2x/day"
                  [(ngModel)]="item.frequency"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Duration</label>
                <input
                  type="text"
                  class="form-input"
                  placeholder="e.g. 7 days"
                  [(ngModel)]="item.duration"
                />
              </div>
            </div>
          </div>
        }

        <button class="add-item-btn" (click)="addPrescriptionItem()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="16"/>
            <line x1="8" y1="12" x2="16" y2="12"/>
          </svg>
          Add Another Medication
        </button>
      </div>

      <div class="modal-footer">
        <button class="btn btn-ghost" (click)="closePrescriptionModal()">Cancel</button>
        <button class="btn btn-primary" (click)="submitPrescription()">Submit Prescription</button>
      </div>
    </div>
  </div>
}

<!-- ═══════════════════════════════════════════
     Referral Modal
     ═══════════════════════════════════════════ -->
@if (showReferralModal) {
  <div class="modal-overlay" (click)="closeReferralModal()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Refer to Specialist</h2>
        <button class="modal-close" (click)="closeReferralModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="form-grid">
          <!-- Specialty -->
          <div class="form-group form-group-full">
            <label class="form-label">Specialty</label>
            <select class="form-input" [(ngModel)]="referralForm.specialty">
              <option value="" disabled>Select a specialty</option>
              @for (spec of SPECIALTIES; track spec) {
                <option [value]="spec">{{ spec }}</option>
              }
            </select>
          </div>

          <!-- Appointment Date -->
          <div class="form-group">
            <label class="form-label">Appointment Date</label>
            <input
              type="date"
              class="form-input"
              [(ngModel)]="referralForm.appointmentDate"
            />
          </div>

          <!-- Appointment Time -->
          <div class="form-group">
            <label class="form-label">Appointment Time</label>
            <input
              type="time"
              class="form-input"
              [(ngModel)]="referralForm.appointmentTime"
            />
          </div>

          <!-- Consultation Mode -->
          <div class="form-group form-group-full">
            <label class="form-label">Consultation Mode</label>
            <div class="radio-group">
              <label class="radio-option">
                <input
                  type="radio"
                  name="consultationMode"
                  value="online"
                  [(ngModel)]="referralForm.consultationMode"
                />
                <span class="radio-label">Online</span>
              </label>
              <label class="radio-option">
                <input
                  type="radio"
                  name="consultationMode"
                  value="offline"
                  [(ngModel)]="referralForm.consultationMode"
                />
                <span class="radio-label">Offline (In-person)</span>
              </label>
            </div>
          </div>

          <!-- Location (shown only when offline) -->
          @if (referralForm.consultationMode === 'offline') {
            <div class="form-group form-group-full">
              <label class="form-label">Location</label>
              <input
                type="text"
                class="form-input"
                placeholder="e.g. City Hospital, Room 204"
                [(ngModel)]="referralForm.location"
              />
            </div>
          }

          <!-- Urgency -->
          <div class="form-group form-group-full">
            <label class="form-label">Urgency</label>
            <select class="form-input" [(ngModel)]="referralForm.urgency">
              <option value="routine">Routine</option>
              <option value="urgent">Urgent</option>
              <option value="emergency">Emergency</option>
            </select>
          </div>

          <!-- Reason -->
          <div class="form-group form-group-full">
            <label class="form-label">Reason for Referral</label>
            <textarea
              class="form-input form-textarea"
              rows="4"
              placeholder="Describe the reason for this referral..."
              [(ngModel)]="referralForm.reason"
            ></textarea>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-ghost" (click)="closeReferralModal()">Cancel</button>
        <button class="btn btn-primary" (click)="submitReferral()">Submit Referral</button>
      </div>
    </div>
  </div>
}
